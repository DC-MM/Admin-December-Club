<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>December Club — Admin Dashboard</title>
  <style>
    :root{
      --gold1:#f6e7b2; --gold2:#d9b86a; --gold3:#8b6a22;
      --wine:#5b0f22; --ink:#120b0d; --paper:#f5ead0; --paper2:#efe0bf;
      --shadow: 0 26px 90px rgba(0,0,0,.42);
      --radius: 14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      color: var(--ink);
      background:
        radial-gradient(900px 650px at 18% 10%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(900px 650px at 85% 12%, rgba(255,255,255,.22), transparent 62%),
        linear-gradient(145deg, var(--gold1), var(--gold2) 45%, var(--gold3));
      padding:22px 16px;
    }
    .wrap{ width:min(1100px,100%); margin:0 auto; }
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      background: rgba(255,255,255,.20);
      border:1px solid rgba(91,15,34,.25);
      border-radius:14px;
      padding:14px 14px;
      box-shadow: var(--shadow);
    }
    h1{ margin:0; font-size:26px; font-weight:600; }
    .top .right{ display:flex; gap:8px; align-items:center; }
    .btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(91,15,34,.55);
      background:
        radial-gradient(240px 120px at 50% 0%, rgba(255,255,255,.22), transparent 60%),
        linear-gradient(180deg, rgba(245,234,208,.92), rgba(230,210,168,.78));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn.secondary{ background: rgba(255,255,255,.22); }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      margin-top:12px;
    }
    @media(max-width:920px){ .grid{ grid-template-columns:1fr; } }
    .card{
      background:
        radial-gradient(900px 540px at 50% 0%, rgba(255,255,255,.34), transparent 62%),
        linear-gradient(180deg, rgba(245,234,208,.92), rgba(239,224,191,.86));
      border-radius:14px;
      border:1px solid rgba(91,15,34,.25);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .filters{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(91,15,34,.35);
      background: rgba(255,255,255,.18);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size:12px;
      cursor:pointer;
    }
    .chip.active{ border-color: rgba(91,15,34,.70); background: rgba(255,255,255,.30); }
    .search{
      display:flex; gap:8px; align-items:center;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid rgba(91,15,34,.35);
      background: rgba(255,255,255,.22);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size:13px;
      outline:none;
    }
    textarea{ min-height:80px; resize:vertical; }
    table{
      width:100%;
      border-collapse:collapse;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size:13px;
    }
    th, td{
      padding:10px 8px;
      border-bottom:1px solid rgba(91,15,34,.18);
      vertical-align:top;
    }
    th{ text-align:left; color: rgba(18,11,13,.75); font-weight:600; }
    .tag{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(91,15,34,.30);
      background: rgba(255,255,255,.18);
      font-size:12px;
    }
    .rowActions{ display:flex; gap:6px; flex-wrap:wrap; }
    .mini{
      padding:6px 8px;
      border-radius:10px;
      border:1px solid rgba(91,15,34,.45);
      background: rgba(255,255,255,.18);
      cursor:pointer;
      font-size:12px;
    }
    .mini.danger{ border-color: rgba(160, 20, 55, .45); }
    .msg{
      margin-top:10px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size:12px; line-height:1.35;
      color: rgba(18,11,13,.80);
      background: rgba(255,255,255,.22);
      border: 1px solid rgba(91,15,34,.22);
      border-radius: 10px;
      padding: 10px 12px;
      display:none;
    }
    .msg.error{ border-color: rgba(160, 20, 55, .35); }
    .muted{ color: rgba(18,11,13,.60); font-size:12px; font-family: ui-sans-serif, system-ui; }
    .two{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    @media(max-width:520px){ .two{ grid-template-columns:1fr; } }
    .hr{ height:1px; background: rgba(91,15,34,.18); margin:10px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Admin Dashboard</h1>
        <div class="muted">Manage members (add / edit / block). Export & Import members.json.</div>
      </div>
      <div class="right">
        <button class="btn secondary" id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Members list -->
      <section class="card">
        <div class="toolbar">
          <div class="filters">
            <button class="chip active" data-filter="all">All</button>
            <button class="chip" data-filter="member">Member</button>
            <button class="chip" data-filter="elite">Elite</button>
            <button class="chip" data-filter="private">Private</button>
          </div>

          <div class="search" style="min-width:280px;">
            <input id="searchInput" type="text" placeholder="Search by number / name / email..." />
          </div>
        </div>

        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th style="width:120px;">Number</th>
                <th>Name</th>
                <th style="width:140px;">Category</th>
                <th style="width:120px;">Tier</th>
                <th style="width:120px;">Status</th>
                <th style="width:180px;">Actions</th>
              </tr>
            </thead>
            <tbody id="membersTbody"></tbody>
          </table>
        </div>

        <div class="msg" id="listMsg"></div>
      </section>

      <!-- RIGHT: Editor -->
      <section class="card">
        <h3 style="margin:0 0 8px;">Add / Edit Member</h3>
        <div class="muted">Tip: member 0000 is protected from delete.</div>
        <div class="hr"></div>

        <form id="editorForm" autocomplete="off">
          <label class="muted">Member Number</label>
          <input id="f_number" type="text" placeholder="0000 / 9-digit etc" />

          <label class="muted" style="margin-top:8px;">Full Name</label>
          <input id="f_name" type="text" placeholder="Full name" />

          <div class="two" style="margin-top:8px;">
            <div>
              <label class="muted">Email</label>
              <input id="f_email" type="email" placeholder="name@example.com" />
            </div>
            <div>
              <label class="muted">Country</label>
              <input id="f_country" type="text" placeholder="UAE" />
            </div>
          </div>

          <div class="two" style="margin-top:8px;">
            <div>
              <label class="muted">Category</label>
              <select id="f_category">
                <option value="member">member</option>
                <option value="elite">elite</option>
                <option value="private">private</option>
              </select>
            </div>
            <div>
              <label class="muted">Tier</label>
              <select id="f_tier">
                <option value="gold">gold</option>
                <option value="wine">wine</option>
                <option value="black">black</option>
              </select>
            </div>
          </div>

          <div class="two" style="margin-top:8px;">
            <div>
              <label class="muted">Active</label>
              <select id="f_active">
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
            </div>
            <div>
              <label class="muted">Banned</label>
              <select id="f_banned">
                <option value="false">false</option>
                <option value="true">true</option>
              </select>
            </div>
          </div>

          <label class="muted" style="margin-top:8px;">Notes</label>
          <textarea id="f_notes" placeholder="Notes..."></textarea>

          <div class="two" style="margin-top:10px;">
            <button class="btn" type="submit" id="saveBtn">Save / Update</button>
            <button class="btn secondary" type="button" id="clearBtn">Clear</button>
          </div>

          <div class="hr"></div>

          <div class="two">
            <button class="btn secondary" type="button" id="exportBtn">Export members.json</button>
            <label class="btn secondary" style="display:flex;align-items:center;justify-content:center;gap:8px; cursor:pointer;">
              Import members.json
              <input id="importFile" type="file" accept="application/json" style="display:none;">
            </label>
          </div>

          <div class="msg" id="editMsg"></div>
        </form>
      </section>
    </div>
  </div>

  <script>
    // ---------------------------
    // Admin guard
    // ---------------------------
    if(sessionStorage.getItem("dc_admin_ok") !== "1"){
      window.location.href = "login.html";
    }

    const $ = (id) => document.getElementById(id);

    function showMsg(el, text, isError=false){
      el.textContent = text;
      el.classList.toggle("error", !!isError);
      el.style.display = "block";
    }
    function hideMsg(el){
      el.textContent = "";
      el.classList.remove("error");
      el.style.display = "none";
    }

    $("logoutBtn").addEventListener("click", () => {
      sessionStorage.removeItem("dc_admin_ok");
      window.location.href = "login.html";
    });

    // ---------------------------
    // Data (in-memory)
    // ---------------------------
    let membersMap = {};
    let activeFilter = "all";
    let searchText = "";

    async function loadMembers(){
      hideMsg($("listMsg"));
      try{
        const res = await fetch("members.json", { cache: "no-store" });
        if(!res.ok) throw new Error("members.json not found");
        const data = await res.json();
        membersMap = data || {};
        render();
      }catch(e){
        showMsg($("listMsg"), "Cannot load members.json. Make sure it exists in the repo root.", true);
      }
    }

    function nowISO(){
      return new Date().toISOString();
    }

    function normalizeBool(v){
      return String(v) === "true";
    }

    function listMembersArray(){
      const arr = Object.values(membersMap || {});
      // ensure each has member_number as key
      for(const key of Object.keys(membersMap)){
        if(!membersMap[key].member_number) membersMap[key].member_number = key;
      }
      return arr.sort((a,b) => String(a.member_number).localeCompare(String(b.member_number)));
    }

    function passesFilter(m){
      if(activeFilter !== "all" && m.category !== activeFilter) return false;
      if(searchText){
        const s = searchText.toLowerCase();
        const hay = [
          m.member_number, m.full_name, m.email, m.country, m.category, m.tier, m.notes
        ].filter(Boolean).join(" ").toLowerCase();
        if(!hay.includes(s)) return false;
      }
      return true;
    }

    function statusText(m){
      if(m.banned) return "blocked";
      if(!m.active) return "inactive";
      return "active";
    }

    function render(){
      const tbody = $("membersTbody");
      tbody.innerHTML = "";

      const rows = listMembersArray().filter(passesFilter);

      if(rows.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" class="muted">No members found.</td>`;
        tbody.appendChild(tr);
        return;
      }

      for(const m of rows){
        const tr = document.createElement("tr");

        const protectedOwner = (String(m.member_number) === "0000");

        tr.innerHTML = `
          <td><span class="tag">${m.member_number}</span></td>
          <td>
            <div style="font-weight:600;">${(m.full_name || "—")}</div>
            <div class="muted">${(m.email || "")}</div>
          </td>
          <td><span class="tag">${m.category || "member"}</span></td>
          <td><span class="tag">${m.tier || "gold"}</span></td>
          <td><span class="tag">${statusText(m)}</span></td>
          <td>
            <div class="rowActions">
              <button class="mini" data-act="edit" data-id="${m.member_number}">Edit</button>
              <button class="mini" data-act="toggleActive" data-id="${m.member_number}">
                ${m.active ? "Deactivate" : "Activate"}
              </button>
              <button class="mini danger" data-act="delete" data-id="${m.member_number}" ${protectedOwner ? "disabled" : ""}>
                Delete
              </button>
            </div>
            ${protectedOwner ? `<div class="muted" style="margin-top:6px;">Owner protected</div>` : ``}
          </td>
        `;

        tbody.appendChild(tr);
      }
    }

    // Filters
    document.querySelectorAll(".chip").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".chip").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        activeFilter = btn.dataset.filter;
        render();
      });
    });

    $("searchInput").addEventListener("input", (e) => {
      searchText = (e.target.value || "").trim();
      render();
    });

    // Row actions (event delegation)
    $("membersTbody").addEventListener("click", (e) => {
      const b = e.target.closest("button");
      if(!b) return;
      const act = b.dataset.act;
      const id = b.dataset.id;
      if(!act || !id) return;

      const m = membersMap[id];
      if(!m) return;

      if(act === "edit"){
        fillForm(m);
        showMsg($("editMsg"), `Editing member ${id}`, false);
      }

      if(act === "toggleActive"){
        m.active = !m.active;
        m.updated_at = nowISO();
        membersMap[id] = m;
        render();
        showMsg($("listMsg"), `Updated active status for ${id}. Don't forget Export.`, false);
      }

      if(act === "delete"){
        if(id === "0000"){
          showMsg($("listMsg"), "Owner (0000) cannot be deleted.", true);
          return;
        }
        const ok = confirm(`Delete member ${id}?`);
        if(!ok) return;
        delete membersMap[id];
        render();
        showMsg($("listMsg"), `Deleted ${id}. Don't forget Export.`, false);
      }
    });

    function fillForm(m){
      $("f_number").value = m.member_number || "";
      $("f_name").value = m.full_name || "";
      $("f_email").value = m.email || "";
      $("f_country").value = m.country || "";
      $("f_category").value = m.category || "member";
      $("f_tier").value = m.tier || "gold";
      $("f_active").value = String(!!m.active);
      $("f_banned").value = String(!!m.banned);
      $("f_notes").value = m.notes || "";
    }

    function clearForm(){
      $("f_number").value = "";
      $("f_name").value = "";
      $("f_email").value = "";
      $("f_country").value = "";
      $("f_category").value = "member";
      $("f_tier").value = "gold";
      $("f_active").value = "true";
      $("f_banned").value = "false";
      $("f_notes").value = "";
      hideMsg($("editMsg"));
    }

    $("clearBtn").addEventListener("click", clearForm);

    // Save / Update
    $("editorForm").addEventListener("submit", (e) => {
      e.preventDefault();
      hideMsg($("editMsg"));

      const member_number = String($("f_number").value || "").trim();
      if(!member_number){
        showMsg($("editMsg"), "Member number is required.", true);
        return;
      }

      // if exists use it; else create
      const exists = !!membersMap[member_number];
      const prev = membersMap[member_number] || {};

      // Protect: no deleting owner already handled; editing is allowed
      const payload = {
        member_number,
        full_name: ($("f_name").value || "").trim(),
        email: ($("f_email").value || "").trim(),
        country: ($("f_country").value || "").trim(),
        category: $("f_category").value,
        tier: $("f_tier").value,
        active: normalizeBool($("f_active").value),
        banned: normalizeBool($("f_banned").value),
        notes: ($("f_notes").value || "").trim(),
        created_at: prev.created_at || nowISO(),
        updated_at: nowISO()
      };

      membersMap[member_number] = payload;
      render();

      showMsg($("editMsg"), `${exists ? "Updated" : "Added"} member ${member_number}. Now click Export to save members.json.`, false);
    });

    // Export JSON
    $("exportBtn").addEventListener("click", () => {
      const json = JSON.stringify(membersMap, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "members.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      showMsg($("listMsg"), "Downloaded members.json. Upload it to your repo to apply changes.", false);
    });

    // Import JSON
    $("importFile").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        membersMap = data || {};
        render();
        showMsg($("listMsg"), "Imported members.json into the dashboard. (Remember Export + upload if you changed anything.)", false);
      }catch(err){
        showMsg($("listMsg"), "Invalid JSON file.", true);
      }finally{
        e.target.value = "";
      }
    });

    // Start
    loadMembers();
  </script>
</body>
</html>
